name: Monitoring Stability and Comparing Results

# Triggers when a pull_request or a push action is configured on master branch
on:
  pull_request_target:

jobs:
  build_privado:
    strategy:
      matrix:
        ref: [{ branch: "${{github.head_ref}}", owner: "${{ github.event.pull_request.head.repo.owner.login }}"}, { branch: "${{github.base_ref}}", owner: "${{ github.event.pull_request.base.repo.owner.login }}"}]
          
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
          
      - name: Install JDK-18
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '18'

      - name: Export Java Home Path
        run: export PATH=$JAVA_HOME/bin:$PATH

      - name: Install sbt
        run: mkdir -p ~/bin && curl -Ls https://raw.githubusercontent.com/dwijnand/sbt-extras/master/sbt > ~/bin/sbt && chmod 0755 ~/bin/sbt

      - name: Set Branch env
        run: echo "BRANCH_UPLOAD_NAME=$(echo ${{ matrix.ref.branch }} | base64)" >> $GITHUB_ENV

      - name: Set Owner env
        run: echo "OWNER_UPLOAD_NAME=$(echo ${{ matrix.ref.owner }} | base64)" >> $GITHUB_ENV

      - name: Clone ${{matrix.ref.owner}}/${{matrix.ref.branch}}
        uses: actions/checkout@v3
        with:
          repository: ${{matrix.ref.owner}}/privado-core
          path: ./temp/${{env.OWNER_UPLOAD_NAME}}-${{env.BRANCH_UPLOAD_NAME}}
          ref: ${{matrix.ref.branch}} 
      
      - name: Build Privado binary for ${{matrix.ref.owner}}/${{matrix.ref.branch}} branch
        run: cd ${GITHUB_WORKSPACE}/temp/${{env.OWNER_UPLOAD_NAME}}-${{env.BRANCH_UPLOAD_NAME}} && ~/bin/sbt -java-home $JAVA_HOME clean && ~/bin/sbt -java-home $JAVA_HOME stage 

      - name: Upload privado binary for next job
        uses: actions/upload-artifact@master
        with:
          name: ${{env.OWNER_UPLOAD_NAME}}-${{env.BRANCH_UPLOAD_NAME}}
          path: /home/runner/work/privado-core/privado-core/temp/${{env.OWNER_UPLOAD_NAME}}-${{env.BRANCH_UPLOAD_NAME}}/target/universal/stage
          
  scan_repositories:
    needs: build_privado
    strategy:
      matrix:
        owner: ["Privado-Demo"]
        repo_name:
          [
            "privado-analytics",
            "privado-accounts-api",
            "shift-privacy-left-app",
          ]

    continue-on-error: true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set Branch env
        run: echo "HEAD_OWNER_NAME=$(echo ${{github.event.pull_request.head.repo.owner.login}} | base64)" >> $GITHUB_ENV && echo "BASE_OWNER_NAME=$(echo ${{github.event.pull_request.base.repo.owner.login}} | base64)" >> $GITHUB_ENV

      - name: Ser Owner env
        run: echo "HEAD_BRANCH_NAME=$(echo ${{github.head_ref}} | base64)" >> $GITHUB_ENV && echo "BASE_BRANCH_NAME=$(echo ${{github.base_ref}} | base64)" >> $GITHUB_ENV
      
      - name: Install JDK-18
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '18'

      - name: Export Java Home Path
        run: export PATH=$JAVA_HOME/bin:$PATH

      - name: Clone Privado-Inc/privado
        uses: actions/checkout@v3
        with:
          repository: "Privado-Inc/privado"
          path: ./privado-core-and-rules/privado

      - name: Download base privado-core binary 
        uses: actions/download-artifact@master
        with:
          name: ${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}
          path: ./privado-core-and-rules/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}/privado-core-binary

      - name: Download head privado-core binary 
        uses: actions/download-artifact@master
        with:
          name: ${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}
          path: ./privado-core-and-rules/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}/privado-core-binary

      - name: Create Folder to store reports
        run: mkdir ${GITHUB_WORKSPACE}/reports && mkdir -p ${GITHUB_WORKSPACE}/${{matrix.repo_name}}_results/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }} && mkdir -p ${GITHUB_WORKSPACE}/${{matrix.repo_name}}_results/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }} && mkdir ${GITHUB_WORKSPACE}/time_results

      - name: Trigger metadata
        run: echo " {\"head_branch\":\"${{github.head_ref}}\", \"base_branch\":\"${{github.base_ref}}\", \"prNumber\":\"${{github.event.number}}\", \"commitID\":\"${GITHUB_SHA}\"}" > ${GITHUB_WORKSPACE}/reports/trigger_metadata.json && cat ${GITHUB_WORKSPACE}/reports/trigger_metadata.json

      - name: Download CPU and Memory usage capture tool
        run: mkdir ${GITHUB_WORKSPACE}/tools && curl https://raw.githubusercontent.com/Privado-Inc/privado-core-results-monitoring/main/capture_usage.sh --output ${GITHUB_WORKSPACE}/tools/capture_usage.sh

      - name: Start monitoring cpu and memory usage
        run: bash ${GITHUB_WORKSPACE}/tools/capture_usage.sh &

      # Setup python 3.8 in the pipeline
      - name: Setup Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      # Setup privado environment in the pipeline
      - name: Setup Privado Env
        run: curl -o- https://raw.githubusercontent.com/Privado-Inc/privado-cli/main/install.sh | bash

      - name: Clone repository
        uses: actions/checkout@v3
        with:
          repository: ${{matrix.owner}}/${{matrix.repo_name}}
          path: ./repos/${{matrix.repo_name}}

      - name: change file permission for ${{ github.event.pull_request.base.repo.owner.login }}/${{github.base_ref}} privado-core binary
        run: chmod 777 ${GITHUB_WORKSPACE}/privado-core-and-rules/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}/privado-core-binary/bin/privado-core

      - name: change file permission for ${{ github.event.pull_request.head.repo.owner.login }}/${{github.head_ref}} privado-core binary
        run: chmod 777 ${GITHUB_WORKSPACE}/privado-core-and-rules/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}/privado-core-binary/bin/privado-core

      - name: Scan ${{matrix.owner}}/${{matrix.repo_name}} (${{ github.event.pull_request.base.repo.owner.login }}/${{github.base_ref}}) using privado scan
        run: cd ${GITHUB_WORKSPACE}/privado-core-and-rules/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}/privado-core-binary/bin && { time ./privado-core scan ${GITHUB_WORKSPACE}/repos/${{matrix.repo_name}} -ic ${GITHUB_WORKSPACE}/privado-core-and-rules/privado --skip-upload; } 2> ${GITHUB_WORKSPACE}/time_results/${{matrix.repo_name}}_time_${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}.txt

      - name: Store ${{matrix.repo_name}}.json (${{ github.event.pull_request.base.repo.owner.login }}/${{github.base_ref}})
        run: cat ${GITHUB_WORKSPACE}/repos/${{matrix.repo_name}}/.privado/privado.json > ${GITHUB_WORKSPACE}/${{matrix.repo_name}}_results/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}/privado.json

      - name: Scan ${{matrix.owner}}/${{matrix.repo_name}} (${{ github.event.pull_request.head.repo.owner.login }}/${{github.head_ref}}) using privado scan
        run: cd ${GITHUB_WORKSPACE}/privado-core-and-rules/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}/privado-core-binary/bin && { time ./privado-core scan ${GITHUB_WORKSPACE}/repos/${{matrix.repo_name}} -ic ${GITHUB_WORKSPACE}/privado-core-and-rules/privado --skip-upload; } 2> ${GITHUB_WORKSPACE}/time_results/${{matrix.repo_name}}_time_${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}.txt

      - name: Store ${{matrix.repo_name}}.json (${{ github.event.pull_request.head.repo.owner.login }}/${{github.head_ref}})
        run: cat ${GITHUB_WORKSPACE}/repos/${{matrix.repo_name}}/.privado/privado.json > ${GITHUB_WORKSPACE}/${{matrix.repo_name}}_results/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}/privado.json
      
      - name: Check if time files are present
        run: ls ${GITHUB_WORKSPACE}/time_results/

      - name: Pass JSON (${{ github.event.pull_request.base.repo.owner.login }}/${{github.base_ref}}) to the next job
        uses: actions/upload-artifact@master
        with:
          name: ${{matrix.repo_name}}_stable
          path: /home/runner/work/privado-core/privado-core/${{matrix.repo_name}}_results/${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}/privado.json
          
      - name: Pass JSON (${{ github.event.pull_request.head.repo.owner.login }}/${{github.head_ref}}) to the next job
        uses: actions/upload-artifact@master
        with:
          name: ${{matrix.repo_name}}_dev
          path: /home/runner/work/privado-core/privado-core/${{matrix.repo_name}}_results/${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}/privado.json
          
      - name: Upload CPU and memory usage file
        uses: actions/upload-artifact@master
        with:
          name: ${{matrix.repo_name}}_cpu
          path: /home/runner/work/privado-core/privado-core/tools/results_1.txt
          
      - name: Upload time stats for repos
        uses: actions/upload-artifact@master
        with:
          name: ${{matrix.repo_name}}_time
          path: /home/runner/work/privado-core/privado-core/time_results
          
      - name: Upload Trigger metadata
        uses: actions/upload-artifact@master
        with:
          name: ${{matrix.repo_name}}_trigger
          path: /home/runner/work/privado-core/privado-core/reports/trigger_metadata.json
          
      - name: Create a comparison report
        run: touch ${GITHUB_WORKSPACE}/comparison_report.csv

      - name: Upload Comparison report
        uses: actions/upload-artifact@master
        with:
          name: comparison_report
          path: /home/runner/work/privado-core/privado-core/comparison_report.csv

      - name: Create Summary report
        run: touch ${GITHUB_WORKSPACE}/summary-report.txt

      - name: Upload Summary Report
        uses: actions/upload-artifact@master
        with: 
          name: summary-report
          path: /home/runner/work/privado-core/privado-core/summary-report.txt

  compare-reports: 
    needs: scan_repositories
    strategy:
      max-parallel: 1
      matrix:
        repo_name:
          [
            "privado-analytics",
            "privado-accounts-api",
            "shift-privacy-left-app",
          ]

    runs-on: ubuntu-latest
    steps: 
      - uses: actions/checkout@v3

      - name: Set Branch env
        run: echo "HEAD_OWNER_NAME=$(echo ${{github.event.pull_request.head.repo.owner.login}} | base64)" >> $GITHUB_ENV && echo "BASE_OWNER_NAME=$(echo ${{github.event.pull_request.base.repo.owner.login}} | base64)" >> $GITHUB_ENV

      - name: Ser Owner env
        run: echo "HEAD_BRANCH_NAME=$(echo ${{github.head_ref}} | base64)" >> $GITHUB_ENV && echo "BASE_BRANCH_NAME=$(echo ${{github.base_ref}} | base64)" >> $GITHUB_ENV

      - name: Download the comparison tool
        run: curl https://raw.githubusercontent.com/Privado-Inc/privado-core-results-monitoring/main/compare.py --output ${GITHUB_WORKSPACE}/compare.py

      - name: Download ${{github.base_ref}} JSON File (${{matrix.repo_name}}) 
        uses: actions/download-artifact@master
        with: 
          name: ${{matrix.repo_name}}_stable
          path: ./${{matrix.repo_name}}/${{github.base_ref}}

      - name: Download ${{github.head_ref}} JSON File (${{matrix.repo_name}})
        uses: actions/download-artifact@master
        with: 
          name: ${{matrix.repo_name}}_dev
          path: ./${{matrix.repo_name}}/{{github.head_ref}}

      - name: Download ${{github.head_ref}} Time Result (${{matrix.repo_name}})
        uses: actions/download-artifact@master
        with: 
          name: ${{matrix.repo_name}}_time
          path: ./${{matrix.repo_name}}

      - name: Download ${{github.head_ref}} CPU and Memory Result (${{matrix.repo_name}})
        uses: actions/download-artifact@master
        with: 
          name: ${{matrix.repo_name}}_cpu
          path: ./${{matrix.repo_name}}
          
      - name: Download Comparison Report
        uses: actions/download-artifact@master
        with: 
          name: comparison_report
          path: ./

      - name: Download Summary Report
        uses: actions/download-artifact@master
        with:
          name: summary-report
          path: ./ 

      - name: Download ${{github.head_ref}} Trigger Metadata Result (${{matrix.repo_name}})
        uses: actions/download-artifact@master
        with: 
          name: ${{matrix.repo_name}}_trigger
          path: ./${{matrix.repo_name}}

      - name: Compare Result (${{matrix.repo_name}})
        run: python ./compare.py ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/${{github.base_ref}}/privado.json ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/${{github.base_ref}}/privado.json ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/results_1.txt ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/trigger_metadata.json ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/${{matrix.repo_name}}_time_${{ env.BASE_OWNER_NAME }}-${{ env.BASE_BRANCH_NAME }}.txt ${GITHUB_WORKSPACE}/${{matrix.repo_name}}/${{matrix.repo_name}}_time_${{ env.HEAD_OWNER_NAME }}-${{ env.HEAD_BRANCH_NAME }}.txt

      - name: Upload Report for Next Job
        uses: actions/upload-artifact@master
        with: 
          name: comparison_report
          path: /home/runner/work/privado-core/privado-core/comparison_report.csv

      - name: upload Summary Report for Next job
        uses: actions/upload-artifact@master
        with:
          name: summary-report
          path: /home/runner/work/privado-core/privado-core/summary-report.txt

  send-result:
    needs: compare-reports
    runs-on: ubuntu-latest
    steps: 
      - uses: actions/checkout@v3

      - name: Download Final Report
        uses: actions/download-artifact@master
        with:
          name: comparison_report
          path: ./report

      - name: Download Summary Report
        uses: actions/download-artifact@master
        with:
          name: summary-report
          path: ./report
      
      - name: Set summary variable
        run: |
          echo "MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$(cat /home/runner/work/privado-core/privado-core/report/summary-report.txt)" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Post results to slack
        uses: MeilCli/slack-upload-file@v3
        with:
          slack_token: ${{ secrets.SLACK_TOKEN }}
          channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
          file_path: "/home/runner/work/privado-core/privado-core/report/comparison_report.csv"
          initial_comment: "Comparison Results generated on ${{github.event.repository.name}} by PR ${{github.event.number}} from branch ${{github.head_ref}} to ${{github.base_ref}} \nPR link https://github.com/Privado-Inc/privado-core/pull/${{github.event.number}} \nSummary Report:\n ${{ env.MESSAGE }}"
          file_type: "csv"